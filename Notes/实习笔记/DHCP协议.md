# DHCP

**DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）**，前身是 BOOTP 协议，是一个局域网的网络协议，使用 UDP 协议工作，统一使用两个 IANA 分配的端口：**67（服务器端），68（客户端）**。DHCP 属于**应用层**，动态获取 IP，DHCP 服务器为主机自动分配 IP。

DHCP一共有 **8** 种报文，各种类型报文的基本功能如下：

|       报文类型      |                                                                                                                                    说明                                                                                                                                   |
| :-------------: | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| Discover （0x01) |                                                 DHCP 客户端在请求 IP 地址时并**不知道 DHCP 服务器的位置，因此 DHCP 客户端会在本地网络内以**广播方式发送 Discover 请求报文，以发现网络中的 DHCP 服务器。**所有收到 Discover 报文的 DHCP 服务器都会发送应答报文**，DHCP客户端据此可以知道网络中存在的 DHCP 服务器的位置。                                                 |
|   Offer（0x02）   |                                   DHCP 服务器收到 Discover 报文后，就会**在所配置的地址池中查找一个合适的 IP 地址，加上相应的租约期限和其他配置信息（如网关、DNS 服务器等），构造一个 Offer 报文，发送给 DHCP 客户端**，告知用户本服务器可以为其提供 IP 地址。但这个报文只是告诉 DHCP 客户端可以提供 IP 地址，**最终还需要客户端通过 ARP 来检测该 IP 地址是否重复。**                                   |
|  Request（0x03）  | DHCP 客户端可能会收到很多 Offer 请求报文，所以必须在这些应答中选择一个。**通常是选择第一个 Offer 应答报文的服务器作为自己的目标服务器，并向该服务器发送一个广播的 Request 请求报文，通告选择的服务器，希望获得所分配的 IP 地址**。另外，DHCP 客户端在成功获取 IP 地址后，在地址使用租期达到 50% 时，会向 DHCP 服务器发送单播 Request 请求报文请求续延租约，如果没有收到 ACK 报文，在租期达到 87.5% 时，会再次发送广播的 Request 请求报文以请求续延租约。 |
|    ACK（0x05）    |                                                                                    DHCP 服务器收到 Request 请求报文后，根据 Request 报文中携带的用户 MAC 来查找有没有相应的租约记录，如果有则发送 ACK 应答报文，通知用户可以使用分配的 IP 地址。                                                                                    |
|    NAK（0x06）    |                                                                                   如果 DHCP 服务器收到 Request 请求报文后，没有发现有相应的租约记录或者由于某些原因无法正常分配IP地址，则向 DHCP 客户端发送 NAK 应答报文，通知用户无法分配合适的 IP 地址。                                                                                  |
|  Release（0x07）  |                                                                             当 DHCP 客户端不再需要使用分配 IP 地址时（一般出现在客户端关机、下线等状况）就会主动向 DHCP 服务器发送 RELEASE 请求报文，告知服务器用户不再需要分配IP地址，请求 DHCP 服务器释放对应的IP地址。                                                                            |
|  Decline（0x04）  |                                                                DHCP 客户端收到 DHCP 服务器 ACK 应答报文**后**，通过**地址冲突检测**发现服务器分配的地址冲突或者由于其他原因导致不能使用，则会**向 DHCP 服务器发送 Decline 请求报文**，通知服务器所分配的 IP 地址不可用，以期获得新的 IP 地址。                                                                |
|   Inform（0x08）  |                                                                    DHCP 客户端如果需要从 DHCP 服务器端获取更为详细的配置信息，则向DHCP 服务器发送 Inform 请求报文；DHCP 服务器在收到该报文后，将根据租约进行查找到相应的配置信息后，向 DHCP 客户端发送 ACK 应答报文。**目前基本上不用了。**                                                                   |

1.  **客户机初始化 & 寻找DHCP服务器（DHCP Discover）**：DHCP 客户端启动时，计算机发现本机上没有任何IP地址设定，将以**广播**方式通过 UDP（源端口 68，目的端口 67）**发送 DHCP Discover 发现信息来寻找 DHCP 服务器，因为客户机还不知道自己属于哪一个网络，所以**封包的源地址为 0.0.0.0 目的地址为 255.255.255.255，向网络发送特定的广播信息。网络上每一台安装了 TCP/IP 协议的主机都会接收这个广播信息，但**只有 DHCP 服务器才会做出响应。**
2.  **分配IP地址 & 提供IP地址租用（DHCP Offer）**：DHCP 服务器**收到**客户端发出的 DHCP discover 广播后，通过解析报文，查询 dhcpd.conf 配置文件。它会从那些还没有租出去的地址中，选择最前面的空置 IP，连同其它 TCP/IP 设定，**通过 UDP（源端口 68，目的端口 67）响应**给客户端一个 DHCP offer 数据包（包中包含IP地址、子网掩码、地址租期等信息）。告诉 DHCP 客户端，该 DHCP 服务器拥有资源，可以提供 DHCP 服务。

    1.  此时还是使用**广播**进行通讯，**源 IP 地址为 DHCP 服务器的 IP 地址**，目标地址为 255.255.255.255。同时，DHCP 服务器为此客户端保留它提供的 IP 地址，从而不会为其他 DHCP 客户分配此 IP 地址。
    2.  由于客户端在开始的时候还没有 IP 地址，所以在其 **DHCP discover 封包内会带有其 MAC 地址信息**，并且有一个XID 编号来辨别该封包，DHCP 服务器响应的 \*\*DHCP offer \*\*封包则会根据这些资料传递给要求租约的客户。
3.  **接受IP地址 & 接受IP租约（DHCP Request）**：DHCP客户端接受到DHCP offer提供信息之后，如果客户机收到网络上多台DHCP服务器的响应，一般是最先到达的那个，然后以**广播**的方式**回答一个DHCP request数据包**（包中包含客户端的MAC地址、接受的租约中的IP地址、提供此租约的DHCP服务器地址等）。**告诉所有DHCP服务器它将接受哪一台服务器提供的IP地址**，所有其他的DHCP服务器撤销它们的提供以便将IP地址提供给下一次IP租用请求
4.  **IP地址分配确认 & 租约确认（DHCP Ack）**：当DHCP服务器接收到客户机的DHCP request之后，会广播返回给客户机一个DHCP ack消息包，表明已经接受客户机的选择，告诉DHCP客户端可以使用它提供的IP地址。并将这一IP地址的合法租用以及其他的配置信息都放入该广播包发给客户机。

    1.  客户端在接收到**DHCP ack**广播后，会向网络发送三个针对此IP地址的**ARP解析请求以执行冲突检测**，查询网络上有没有其它机器使用该IP地址；如果发现该IP地址已经被使用，客户机会发出一个**DHCP decline**数据包给DHCP服务器，拒绝此IP地址租约，并重新发送**DHCP discover**信息。此时，在DHCP服务器管理控制台中，会**显示此IP地址为BAD\_ADDRESS。**
    2.  如果网络上没有其它主机使用此IP地址，则客户机的TCP/IP使用租约中提供的IP地址完成初始化，从而可以和其他网络中的主机进行通讯。
5.  **重新登录**：以后DHCP客户端每次重新登录网络时，就**不需要再**发送**DHCP discover**发现信息了，而是**直接发送包含前一次所分配的IP地址**的**DHCP request**请求信息。当DHCP服务器收到这一信息后，它会尝试让DHCP客户机继续使用原来的IP地址，并回答一个**DHCP ack**确认信息。如果此IP地址已无法再分配给原来的DHCP客户端使用时，则DHCP服务器给DHCP客户端回答一个**DHCP nack**否认信息。当原来的DHCP客户机收到此**DHCP nack**否认信息后，它就**必须重新发送DHCP discover**发现信息来请求新的IP地址。

> [DHCP协议详解 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/265293856)

|    |    |    |
| :- | :- | :- |
|    |    |    |
|    |    |    |
|    |    |    |
|    |    |    |
|    |    |    |
|    |    |    |
|    |    |    |
|    |    |    |

## DHCP Snopping

DHCP Snooping 是 DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）的一种安全特性，用于保证 DHCP 客户端从合法的 DHCP 服务器获取 IP 地址，并记录 DHCP 客户端 IP 地址与 MAC 地址等参数的对应关系。DHCP Snooping 可以抵御网络中针对 DHCP 的各种攻击，为用户提供更安全的网络环境和更稳定的网络服务。

> [什么是DHCP Snooping? 为什么需要DHCP Snooping？ - 华为](https://info.support.huawei.com/info-finder/encyclopedia/zh/DHCP+Snooping.html)

