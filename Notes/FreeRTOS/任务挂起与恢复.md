# 任务挂起与恢复

## 任务挂起

需将宏`INCLUDE_vTaskSuspend`配置为 1

### API

```c
void vTaskSuspend( TaskHandle_t xTaskToSuspend );
```

**参数说明：**

- *xTaskToSuspend* 被挂起的任务句柄。传递空句柄将导致调用任务被暂停。

### 具体流程

1. 根据任务柄获取任务控制块，若任务柄为 NULL，则为该任务本身
2. 将要挂起的任务从相应的任务状态列表和时间列表中移除
3. 将待挂起任务的任务状态列表插入挂起态任务列表末尾
4. 判断任务调度器是否运行，运行则更新下一次阻塞时间，防止被挂起任务为下一次阻塞超时。
5. 若挂起的任务为本身，且调度器正在运行，需要进行一次任务切换
6. 若调度器没有运行，则判断挂起任务数是否等于任务总数，若是则当前控制块赋值为 NULL，反之则寻找下一个最高优先级任务

**第 4 步中防止被挂起任务为下一次阻塞超时？**

假如现在有 A、B 两个任务都为阻塞态，阻塞时间都为 20 ms 且 A 的优先级更高，若此时将 A 任务挂起，阻塞时间到了 20 ms，则应该挂起 B 才对，因此必须更新下一次阻塞时间。



## 任务恢复

### 任务中恢复

需将宏 `INCLUDE_vTaskSuspend`配置为 1API

### API

```c
void vTaskResume( TaskHandle_t xTaskToResume );
```

**参数说明：**

- *xTaskToResume* 要恢复的任务句柄。

#### 具体流程

1. 恢复任务不能为正在运行任务且不能为 NULL
2. 判断任务是否被挂起，若是则将该任务从挂起列表中移除，并将该任务添加到就绪列表中
3. 判断恢复的任务优先级是否大于当前正在运行的任务，若是则执行任务切换

### 中断中恢复

需将宏 include_vTaskSuspend 和 INCLUDE_xTaskResumeFromISR 定义为 1

### API

```c
BaseType_t xTaskResumeFromISR( TaskHandle_t xTaskToResume );
```

**参数说明：**

- *xTaskToResume* 要恢复的任务句柄。

**返回值：**

- 恢复任务导致任务切换，返回 pdTRUE
- 没有进行任务切换，返回 pdFALSE

#### 具体流程

1. 关闭 FreeRTOS 可管理中断，防止被其他的中断打断，并返回关闭前 basepri 寄存器的值
2. 判断是否有挂起任务，若无则无需操作。若有则进一步检查调度器是否挂起
3. 若调度器未挂起则判断恢复的这个任务优先级是否大于正在执行的任务，若是则将 xYieldRequired 标记为 pdTRUE，表示需要进行一次任务切换，将被恢复的任务从挂起列表中移除，并将该任务添加到就绪列表中
4. 若调度器挂起，就将恢复的任务插入等待就绪列表，直到调度器被恢复再进行任务的处理
5. 恢复前面保存的 basepri 寄存器的值，返回 xYieldRequired 的值用于觉得是否需要进行任务切换


