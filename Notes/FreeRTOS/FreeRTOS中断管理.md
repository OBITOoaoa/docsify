# FreeRTOS 中断管理

中断的流程想必大家都懂了，这里主要讲 FreeRTOS 中的中断管理。

## 中断优先级分组

STM32 的中断优先级分为抢占优先级和子优先级，抢占优先级定义了一个中断是否可以抢占另一个正在执行的中断。 当两个抢占优先级相同的中断同时发生时，子优先级决定首先执行哪个中断。

ARM Cortex-M 使用了 8 位宽的寄存器来配置中断的优先等级，但 STM32 只用到了高四位，总共 16 级的中断优先等级。

**优先级分组 5 种分配方式如下：**

| 优先级分组           | 抢占优先级        | 子优先级        | 优先级配置寄存器高 4 位                   |
| -------------------- | ----------------- | --------------- | ----------------------------------------- |
| NVIC_PriorityGroup_0 | 0 级抢占优先级    | 0-15 级子优先级 | 0bit 用于抢占优先级     4bit 用于子优先级 |
| NVIC_PriorityGroup_1 | 0-1 级抢占优先级  | 0-7 级子优先级  | 1bit 用于抢占优先级     3bit 用于子优先级 |
| NVIC_PriorityGroup_2 | 0-3 级抢占优先级  | 0-3 级子优先级  | 2bit 用于抢占优先级     2bit 用于子优先级 |
| NVIC_PriorityGroup_3 | 0-7 级抢占优先级  | 0-1 级子优先级  | 3bit 用于抢占优先级     1bit 用于子优先级 |
| NVIC_PriorityGroup_4 | 0-15 级抢占优先级 | 0 级子优先级    | 4bit 用于抢占优先级     0bit 用于子优先级 |

使用 FreeRTOS 的中断管理前必须调用`NVIC_PriorityGroupConfig( NVIC_PriorityGroup_4 )`来确保所有优先级位都被指定为抢占优先级位。对于任何使用一个 RTOS API 函数的中断服务程序， 必须为其手动设置为一个数值优先级， 这个值必须大于等于 `configMAX_SYSCALL_INTERRUPT_PRIORITY` 设定的值。

**注意：中断优先级数值越小越优先，任务优先级数值越大越优先**

**FreeRTOS中，实际上是没有中断的，中断还是由硬件产生**。以STM32为例，中断请求的响应过程还是由STM32的中断服务函数完成，而 FreeRTOS 在其中的作用可以说成是唤醒某个阻塞或就绪任务。







